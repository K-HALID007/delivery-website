<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard Debug</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #1e293b;
            color: white;
        }
        .container {
            background: #334155;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .success { color: #10b981; }
        .error { color: #ef4444; }
        .warning { color: #f59e0b; }
        .info { color: #3b82f6; }
        button {
            background: #f59e0b;
            color: #1e293b;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #d97706;
        }
        .log {
            background: #1e293b;
            padding: 15px;
            border-radius: 5px;
            margin-top: 10px;
            max-height: 400px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 14px;
        }
        .data-display {
            background: #475569;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 4px solid #f59e0b;
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }
        .stat-card {
            background: #475569;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #f59e0b;
        }
        .stat-label {
            font-size: 0.9em;
            color: #cbd5e1;
            margin-top: 5px;
        }
        .shipment-card {
            background: #475569;
            padding: 10px;
            border-radius: 6px;
            margin: 5px 0;
            border-left: 3px solid #10b981;
        }
        .user-card {
            background: #475569;
            padding: 10px;
            border-radius: 6px;
            margin: 5px 0;
            border-left: 3px solid #3b82f6;
        }
    </style>
</head>
<body>
    <h1>üîç Admin Dashboard Debug Tool</h1>
    <p>Direct testing of admin dashboard APIs with real data display</p>

    <div class="container">
        <h2>üîê Admin Authentication</h2>
        <div id="auth-status"></div>
        <button onclick="checkAdminAuth()">Check Admin Auth</button>
        <button onclick="loginAsAdmin()">Login as Admin</button>
        <button onclick="clearAdminStorage()">Clear Admin Storage</button>
    </div>

    <div class="container">
        <h2>üìä Dashboard Summary</h2>
        <div id="summary-status"></div>
        <div id="summary-display"></div>
        <button onclick="loadSummaryData()">Load Summary Data</button>
    </div>

    <div class="container">
        <h2>üì¶ Shipments Data</h2>
        <div id="shipments-status"></div>
        <div id="shipments-display"></div>
        <button onclick="loadShipmentsData()">Load Shipments Data</button>
    </div>

    <div class="container">
        <h2>üë• Users Data</h2>
        <div id="users-status"></div>
        <div id="users-display"></div>
        <button onclick="loadUsersData()">Load Users Data</button>
    </div>

    <div class="container">
        <h2>üìà Analytics Data</h2>
        <div id="analytics-status"></div>
        <div id="analytics-display"></div>
        <button onclick="loadAnalyticsData()">Load Analytics Data</button>
    </div>

    <div class="container">
        <h2>üîÑ Auto-Refresh Test</h2>
        <div id="refresh-status"></div>
        <button onclick="startAutoRefresh()">Start Auto-Refresh</button>
        <button onclick="stopAutoRefresh()">Stop Auto-Refresh</button>
    </div>

    <div class="container">
        <h2>üìù Debug Logs</h2>
        <div id="logs" class="log"></div>
        <button onclick="clearLogs()">Clear Logs</button>
        <button onclick="exportLogs()">Export Logs</button>
    </div>

    <script>
        const API_URL = 'http://localhost:5000/api';
        let autoRefreshInterval = null;

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logElement = document.getElementById('logs');
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : 'info';
            logElement.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(`[${timestamp}] ${message}`);
        }

        function getAdminHeaders() {
            const token = sessionStorage.getItem('admin_token');
            return {
                'Content-Type': 'application/json',
                ...(token && { Authorization: `Bearer ${token}` })
            };
        }

        async function checkAdminAuth() {
            log('üîê Checking admin authentication...', 'info');
            
            const token = sessionStorage.getItem('admin_token');
            const adminData = sessionStorage.getItem('admin_data');
            
            const authDiv = document.getElementById('auth-status');
            
            if (token) {
                log('‚úÖ Admin token found', 'success');
                
                // Validate token format
                const tokenParts = token.split('.');
                if (tokenParts.length === 3) {
                    log('‚úÖ Token format is valid (JWT)', 'success');
                    authDiv.innerHTML = `
                        <div class="success">‚úÖ Valid JWT Token Found</div>
                        <div class="info">Token: ${token.substring(0, 50)}...</div>
                    `;
                } else {
                    log('‚ö†Ô∏è Token format is invalid', 'warning');
                    authDiv.innerHTML = `<div class="warning">‚ö†Ô∏è Invalid token format</div>`;
                }
                
                if (adminData) {
                    try {
                        const parsed = JSON.parse(adminData);
                        log(`‚úÖ Admin data: ${parsed.name || parsed.email}`, 'success');
                        authDiv.innerHTML += `<div class="success">‚úÖ Admin: ${parsed.name || parsed.email}</div>`;
                    } catch (e) {
                        log('‚ö†Ô∏è Admin data corrupted', 'warning');
                        authDiv.innerHTML += `<div class="warning">‚ö†Ô∏è Admin data corrupted</div>`;
                    }
                }
            } else {
                log('‚ùå No admin token found', 'error');
                authDiv.innerHTML = `
                    <div class="error">‚ùå No admin token found</div>
                    <div class="warning">‚ö†Ô∏è Please login as admin first</div>
                `;
            }
        }

        async function loginAsAdmin() {
            log('üîë Attempting admin login...', 'info');
            
            const email = prompt('Enter admin email:', 'admin@gmail.com');
            const password = prompt('Enter admin password:', 'admin123');
            
            if (!email || !password) {
                log('‚ùå Login cancelled', 'warning');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/auth/admin/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email, password })
                });

                const data = await response.json();
                
                if (response.ok && data.success) {
                    sessionStorage.setItem('admin_token', data.token);
                    sessionStorage.setItem('admin_data', JSON.stringify(data.admin));
                    
                    log('‚úÖ Admin login successful', 'success');
                    document.getElementById('auth-status').innerHTML = `
                        <div class="success">‚úÖ Login Successful</div>
                        <div class="info">Admin: ${data.admin.name || data.admin.email}</div>
                    `;
                } else {
                    log(`‚ùå Login failed: ${data.message}`, 'error');
                    document.getElementById('auth-status').innerHTML = `
                        <div class="error">‚ùå Login Failed: ${data.message}</div>
                    `;
                }
            } catch (error) {
                log(`‚ùå Login error: ${error.message}`, 'error');
                document.getElementById('auth-status').innerHTML = `
                    <div class="error">‚ùå Login Error: ${error.message}</div>
                `;
            }
        }

        async function loadSummaryData() {
            log('üìä Loading admin summary data...', 'info');
            
            const statusDiv = document.getElementById('summary-status');
            const displayDiv = document.getElementById('summary-display');
            
            try {
                const response = await fetch(`${API_URL}/admin/summary`, {
                    headers: getAdminHeaders()
                });
                
                log(`üì° Summary API Response: ${response.status} ${response.statusText}`, 'info');
                
                if (response.ok) {
                    const data = await response.json();
                    log(`‚úÖ Summary data loaded successfully`, 'success');
                    
                    statusDiv.innerHTML = `<div class="success">‚úÖ Summary Data Loaded</div>`;
                    
                    displayDiv.innerHTML = `
                        <div class="grid">
                            <div class="stat-card">
                                <div class="stat-number">${data.totalUsers || 0}</div>
                                <div class="stat-label">Total Users</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number">${data.activeShipments || 0}</div>
                                <div class="stat-label">Active Shipments</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number">‚Çπ${data.totalRevenue || 0}</div>
                                <div class="stat-label">Total Revenue</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number">${data.pendingDeliveries || 0}</div>
                                <div class="stat-label">Pending Deliveries</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number">${data.totalPartners || 0}</div>
                                <div class="stat-label">Total Partners</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number">${data.activePartners || 0}</div>
                                <div class="stat-label">Active Partners</div>
                            </div>
                        </div>
                        <div class="data-display">
                            <strong>Raw API Response:</strong><br>
                            <pre>${JSON.stringify(data, null, 2)}</pre>
                        </div>
                    `;
                } else {
                    const errorData = await response.json();
                    log(`‚ùå Summary API failed: ${errorData.message}`, 'error');
                    statusDiv.innerHTML = `<div class="error">‚ùå API Failed: ${errorData.message}</div>`;
                    
                    if (response.status === 401) {
                        statusDiv.innerHTML += `<div class="warning">‚ö†Ô∏è Authentication failed - please login</div>`;
                    }
                }
            } catch (error) {
                log(`‚ùå Summary API error: ${error.message}`, 'error');
                statusDiv.innerHTML = `<div class="error">‚ùå API Error: ${error.message}</div>`;
            }
        }

        async function loadShipmentsData() {
            log('üì¶ Loading shipments data...', 'info');
            
            const statusDiv = document.getElementById('shipments-status');
            const displayDiv = document.getElementById('shipments-display');
            
            try {
                const response = await fetch(`${API_URL}/admin/shipments/recent`, {
                    headers: getAdminHeaders()
                });
                
                log(`üì° Shipments API Response: ${response.status} ${response.statusText}`, 'info');
                
                if (response.ok) {
                    const data = await response.json();
                    log(`‚úÖ Shipments data loaded: ${data.length} shipments`, 'success');
                    
                    statusDiv.innerHTML = `<div class="success">‚úÖ ${data.length} Shipments Loaded</div>`;
                    
                    if (data.length > 0) {
                        let shipmentsHtml = '<h4>Recent Shipments:</h4>';
                        data.forEach((shipment, index) => {
                            shipmentsHtml += `
                                <div class="shipment-card">
                                    <strong>${shipment.id || shipment.trackingId}</strong> - 
                                    <span style="color: #10b981;">${shipment.status}</span>
                                    <br><small><strong>Customer:</strong> ${shipment.customer}</small>
                                    <br><small><strong>Route:</strong> ${shipment.origin} ‚Üí ${shipment.destination}</small>
                                    <br><small><strong>Date:</strong> ${new Date(shipment.date).toLocaleString()}</small>
                                </div>
                            `;
                        });
                        
                        displayDiv.innerHTML = shipmentsHtml + `
                            <div class="data-display">
                                <strong>Raw API Response (first 2 shipments):</strong><br>
                                <pre>${JSON.stringify(data.slice(0, 2), null, 2)}</pre>
                            </div>
                        `;
                    } else {
                        displayDiv.innerHTML = `
                            <div class="warning">‚ö†Ô∏è No shipments found in database</div>
                            <div class="info">This is why admin dashboard shows empty shipments</div>
                        `;
                    }
                } else {
                    const errorData = await response.json();
                    log(`‚ùå Shipments API failed: ${errorData.message}`, 'error');
                    statusDiv.innerHTML = `<div class="error">‚ùå API Failed: ${errorData.message}</div>`;
                }
            } catch (error) {
                log(`ÔøΩÔøΩ Shipments API error: ${error.message}`, 'error');
                statusDiv.innerHTML = `<div class="error">‚ùå API Error: ${error.message}</div>`;
            }
        }

        async function loadUsersData() {
            log('üë• Loading users data...', 'info');
            
            const statusDiv = document.getElementById('users-status');
            const displayDiv = document.getElementById('users-display');
            
            try {
                const response = await fetch(`${API_URL}/admin/users`, {
                    headers: getAdminHeaders()
                });
                
                log(`üì° Users API Response: ${response.status} ${response.statusText}`, 'info');
                
                if (response.ok) {
                    const data = await response.json();
                    log(`‚úÖ Users data loaded: ${data.length} users`, 'success');
                    
                    statusDiv.innerHTML = `<div class="success">‚úÖ ${data.length} Users Loaded</div>`;
                    
                    if (data.length > 0) {
                        let usersHtml = '<h4>Recent Users:</h4>';
                        data.slice(0, 10).forEach((user, index) => {
                            usersHtml += `
                                <div class="user-card">
                                    <strong>${user.name}</strong> - ${user.email}
                                    <br><small><strong>Role:</strong> ${user.role} | 
                                    <strong>Active:</strong> ${user.isActive ? 'Yes' : 'No'} | 
                                    <strong>Joined:</strong> ${new Date(user.createdAt).toLocaleDateString()}</small>
                                </div>
                            `;
                        });
                        
                        displayDiv.innerHTML = usersHtml + `
                            <div class="data-display">
                                <strong>Raw API Response (first 2 users):</strong><br>
                                <pre>${JSON.stringify(data.slice(0, 2), null, 2)}</pre>
                            </div>
                        `;
                    } else {
                        displayDiv.innerHTML = `
                            <div class="warning">‚ö†Ô∏è No users found in database</div>
                            <div class="info">This is why admin dashboard shows empty users</div>
                        `;
                    }
                } else {
                    const errorData = await response.json();
                    log(`‚ùå Users API failed: ${errorData.message}`, 'error');
                    statusDiv.innerHTML = `<div class="error">‚ùå API Failed: ${errorData.message}</div>`;
                }
            } catch (error) {
                log(`‚ùå Users API error: ${error.message}`, 'error');
                statusDiv.innerHTML = `<div class="error">‚ùå API Error: ${error.message}</div>`;
            }
        }

        async function loadAnalyticsData() {
            log('üìà Loading analytics data...', 'info');
            
            const statusDiv = document.getElementById('analytics-status');
            const displayDiv = document.getElementById('analytics-display');
            
            try {
                const response = await fetch(`${API_URL}/admin/analytics/realtime`, {
                    headers: getAdminHeaders()
                });
                
                log(`üì° Analytics API Response: ${response.status} ${response.statusText}`, 'info');
                
                if (response.ok) {
                    const data = await response.json();
                    log(`‚úÖ Analytics data loaded successfully`, 'success');
                    
                    statusDiv.innerHTML = `<div class="success">‚úÖ Analytics Data Loaded</div>`;
                    
                    let analyticsHtml = '<h4>Analytics Overview:</h4>';
                    
                    if (data.statusDistribution) {
                        analyticsHtml += '<div class="data-display"><strong>Status Distribution:</strong><br>';
                        data.statusDistribution.forEach(status => {
                            analyticsHtml += `${status._id}: ${status.count}<br>`;
                        });
                        analyticsHtml += '</div>';
                    }
                    
                    if (data.shipmentTrends) {
                        analyticsHtml += `<div class="data-display"><strong>Shipment Trends:</strong> ${data.shipmentTrends.length} data points</div>`;
                    }
                    
                    if (data.regionalData) {
                        analyticsHtml += `<div class="data-display"><strong>Regional Data:</strong> ${data.regionalData.length} regions</div>`;
                    }
                    
                    displayDiv.innerHTML = analyticsHtml + `
                        <div class="data-display">
                            <strong>Raw API Response:</strong><br>
                            <pre>${JSON.stringify(data, null, 2)}</pre>
                        </div>
                    `;
                } else {
                    const errorData = await response.json();
                    log(`‚ùå Analytics API failed: ${errorData.message}`, 'error');
                    statusDiv.innerHTML = `<div class="error">‚ùå API Failed: ${errorData.message}</div>`;
                }
            } catch (error) {
                log(`‚ùå Analytics API error: ${error.message}`, 'error');
                statusDiv.innerHTML = `<div class="error">‚ùå API Error: ${error.message}</div>`;
            }
        }

        function startAutoRefresh() {
            log('üîÑ Starting auto-refresh...', 'info');
            
            const refreshDiv = document.getElementById('refresh-status');
            refreshDiv.innerHTML = '<div class="info">üîÑ Auto-refreshing every 10 seconds...</div>';
            
            autoRefreshInterval = setInterval(async () => {
                const timestamp = new Date().toLocaleTimeString();
                log(`üîÑ [${timestamp}] Auto-refresh triggered`, 'info');
                
                // Refresh all data
                await loadSummaryData();
                await loadShipmentsData();
                await loadUsersData();
            }, 10000);
        }

        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
                log('‚èπÔ∏è Auto-refresh stopped', 'info');
                document.getElementById('refresh-status').innerHTML = '<div class="warning">‚èπÔ∏è Auto-refresh stopped</div>';
            }
        }

        function clearAdminStorage() {
            sessionStorage.removeItem('admin_token');
            sessionStorage.removeItem('admin_data');
            localStorage.clear();
            log('üóëÔ∏è Admin storage cleared', 'warning');
            document.getElementById('auth-status').innerHTML = '<div class="warning">üóëÔ∏è Storage cleared - please login again</div>';
        }

        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
        }

        function exportLogs() {
            const logs = document.getElementById('logs').innerText;
            const blob = new Blob([logs], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `admin-debug-logs-${new Date().toISOString().slice(0, 19)}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Auto-run initial checks
        window.onload = function() {
            log('üöÄ Admin Dashboard Debug Tool Started', 'info');
            checkAdminAuth();
        };
    </script>
</body>
</html>